# 测试总结

## 已完成的工作

### 1. ✅ 增加 NMF 迭代次数和收敛容差参数

**修改文件**: `src/ui/panels/nmf_panel.py`

- **最大迭代次数**: 从 200 增加到 **500**（默认值）
- **新增收敛容差参数**: `nmf_tol`，默认值为 `1e-4`
  - 范围: 1e-10 到 1.0
  - 精度: 10位小数
  - 工具提示: 说明收敛容差的作用

**修改文件**: `src/ui/main_window.py`

- 更新所有 NMF 实例化代码，添加 `tol` 参数
- 更新设置保存/加载代码，支持 `nmf_tol` 参数
- 默认值更新: `nmf_max_iter` 从 200 更新为 500

**影响**:
- 减少 NMF 收敛警告（`ConvergenceWarning`）
- 提供更精确的收敛控制
- 用户可以根据数据复杂度调整迭代次数和容差

### 2. ✅ 标记旧方法为废弃

**修改文件**: `src/ui/main_window.py`

为以下方法添加了废弃注释：
- `setup_plotting_tab()` - 现在使用 `PlottingSettingsTab` 类
- `setup_file_controls_tab()` - 现在使用 `FileControlsTab` 类
- `setup_peak_detection_tab()` - 现在使用 `PeakDetectionTab` 类
- `setup_physics_tab()` - 现在使用 `PhysicsTab` 类

**说明**:
- 这些方法保留用于兼容性
- 实际功能已由新的 Tab 组件类实现
- 如果新组件工作正常，可以考虑完全移除这些旧方法

### 3. ✅ 运行测试

**命令**: `conda activate OBS-FWL && python main.py`

程序已在后台运行，可以进行以下测试：

## 测试清单

### 基础功能测试

- [ ] **程序启动**: 检查程序是否能正常启动，无错误
- [ ] **主窗口显示**: 检查主窗口是否正常显示
- [ ] **Tab 组件**: 点击各个功能按钮，检查 Tab 窗口是否正常打开

### Tab 功能测试

#### 1. 绘图与预处理 Tab (`PlottingSettingsTab`)
- [ ] X 轴截断设置是否正常
- [ ] 预处理参数（QC、BE、AsLS等）是否正常
- [ ] 绘图模式设置是否正常
- [ ] 控件值是否能正确保存和加载

#### 2. 文件扫描与独立Y轴 Tab (`FileControlsTab`)
- [ ] 文件扫描功能是否正常
- [ ] 独立Y轴控制是否正常
- [ ] NMF组分控制是否正常
- [ ] 组瀑布图控制是否正常

#### 3. 波峰检测 Tab (`PeakDetectionTab`)
- [ ] 波峰检测参数设置是否正常
- [ ] 峰值标记样式设置是否正常
- [ ] 垂直参考线设置是否正常
- [ ] 图例重命名功能是否正常（扫描文件并加载）

#### 4. 物理验证 Tab (`PhysicsTab`)
- [ ] 散射尾部拟合设置是否正常
- [ ] 拟合曲线样式设置是否正常
- [ ] 运行拟合功能是否正常

### NMF 分析测试

- [ ] **NMF 配置**: 检查 NMF 参数设置界面
  - [ ] 组件数量设置
  - [ ] **最大迭代次数**（应该是 500）
  - [ ] **收敛容差**（应该是 1e-4）
  - [ ] 预滤波设置
- [ ] **运行 NMF**: 运行 NMF 分析，检查是否还有收敛警告
- [ ] **NMF 结果**: 检查 NMF 结果窗口是否正常显示
- [ ] **样式配置**: 检查样式配置是否正确应用到 NMF 窗口

### 文件操作测试

- [ ] **文件夹扫描**: 选择文件夹，检查文件扫描是否正常
- [ ] **跳过行数检测**: 检查自动检测跳过行数功能是否正常
- [ ] **文件分组**: 检查文件分组功能是否正常
- [ ] **图例重命名**: 检查图例重命名功能是否正常

### 兼容性测试

- [ ] **旧代码兼容**: 检查通过 `self.xxx` 访问 Tab 控件是否正常
- [ ] **设置保存/加载**: 修改设置后关闭程序，重新打开检查设置是否保存

## 已知问题

1. **NMF 收敛警告**: 已通过增加迭代次数和添加收敛容差参数解决
2. **subplot1_controller 错误**: 已修复
3. **derivative_check 错误**: 已修复

## 下一步

如果测试通过，可以考虑：

1. **完全移除旧方法**: 如果新组件工作正常，可以删除 `setup_*_tab` 方法
2. **优化 ConfigBinder**: 可以进一步使用 ConfigBinder 替换手动信号连接
3. **添加单元测试**: 为新组件添加单元测试

## 注意事项

- 程序已在后台运行，可以在 GUI 中进行交互测试
- 如果遇到错误，请检查控制台输出
- 建议逐步测试各个功能，确保每个 Tab 都正常工作

